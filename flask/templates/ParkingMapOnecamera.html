<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>é§è¼ªçŠ¶æ³ğŸ”´</title>
  <style>
    body {
      margin: 0;
      background-color: #ffeec0;
      font-family: sans-serif;
    }

  .map-container {
    position: relative;
    width: 100%;
    max-width: 600px;
    margin: 0 auto;
    aspect-ratio: 9 / 13;
    background-color: #fff7e0;
    /* display: flex; â† å‰Šé™¤ï¼ */
  }

    .column {
      width: 14%;
      height: 60%;
      background-color: #ddd;
      border: 2px solid #444;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      position: relative;
    }
    .column2 {
    width: 14%;
    height: 90%;
    background-color: #ddd;
    border: 2px solid #444;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    position: relative;
  }

  .column1 {
      width: 14%;
      height: 30%;
      background-color: #ddd;
      border: 2px solid #444;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      position: relative;
    }

  /* å„ã‚«ãƒ©ãƒ ã¯è‡ªç”±é…ç½®ã«å¤‰æ›´ */
  .column, .column1, .column2 {
  position: absolute;
  background-color: #ddd;
  border: 2px solid #444;
  }

.column2::before,
.column2::after {
  content: "";
  position: absolute;
  left: 0;
  width: 100%;
  height: 1px;
  background-color: #444;
}

.column2::before {
  top: 33.33%;
}

.column2::after {
  top: 66.66%;
}
.column1.vacant { background-color: #d4ffd4; }     /* ç·‘ãŒã‹ã£ãŸèƒŒæ™¯ */
.column1.few    { background-color: #fff0cc; }     /* ã‚ªãƒ¬ãƒ³ã‚¸ãŒã‹ã£ãŸèƒŒæ™¯ */
.column1.occupied { background-color: #ffd4d4; }   /* èµ¤ãŒã‹ã£ãŸèƒŒæ™¯ */
.column1.error { background-color: #e0e0e0; }       /* ç°è‰² */

    .column::before {
      content: "";
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      height: 1px;
      background: #555;
    }

    .slot {
  position: absolute;
  width: 35px;
  height: 35px;
  border-radius: 50%;
  color: #fff;
  font-weight: bold;
  text-align: center;
  line-height: 35px;
  font-size: 18px;
  cursor: pointer;
  user-select: none;
  box-shadow: 0 0 4px rgba(0, 0, 0, 0.3);
  transform: translate(-50%, -50%);
}

    /* æ–°ã—ã„è‰²è¨­å®š: -1=ç°è‰², 0=èµ¤è‰², 1=é»„è‰², 2=ç·‘è‰² */
    .error { background-color: gray; }      /* -1: ç°è‰² */
    .occupied { background-color: red; }    /* 0: èµ¤è‰² */
    .few { background-color: orange; }      /* 1: é»„è‰²ï¼ˆã‚ªãƒ¬ãƒ³ã‚¸ï¼‰ */
    .vacant { background-color: green; }    /* 2: ç·‘è‰² */

    .slot-info {
      position: fixed;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      border: 1px solid #aaa;
      border-radius: 8px;
      padding: 10px 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      display: none;
      z-index: 100;
    }
    .camera-floating {
      position: absolute;
      display: none;
      background: white;
      border: 1px solid #aaa;
      border-radius: 8px;
      padding: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      z-index: 200;
      white-space: nowrap;
    }
    .camera-floating img {
      max-width: 500px;
      max-height: 425px;
      margin: 2px;
      vertical-align: middle;
    }
  </style>
</head>
<body>
<div style="position: absolute; top: 10px; right: 10px;">
  <a href="/archive" style="text-decoration: none; background: #444; color: white; padding: 8px 12px; border-radius: 5px; font-size: 14px;">æ··é›‘äºˆæ¸¬æƒ…å ±ã¸</a>
</div>
<div style="position: absolute; top: 50px; right: 10px;">
  <a href="/show_image" style="text-decoration: none; background: #444; color: white; padding: 8px 12px; border-radius: 5px; font-size: 14px;">å–å¾—ç”»åƒè¡¨ç¤º</a>
</div>
  <h2 style="text-align: center; color: #333; margin-top: 1rem;">ç¾åœ¨ã®é§è¼ªçŠ¶æ³ğŸ”´</h2>


<div class="map-container" id="map">
  <div class="column1" style="top: 65%; left: 80%;">
    <div class="slot" data-id="1" style="top: 50%; left: 50%;"></div>
  </div>
  <div class="column1" style="top: 35%; left: 80%;">
    <div class="slot" data-id="2" style="top: 50%; left: 50%;"></div>
  </div>
  <div class="column1" style="top: 5%; left: 80%;">
    <div class="slot" data-id="3" style="top: 50%; left: 50%;"></div>
    </div>
  <div class="column1" style="top: 35%; left: 53%;">
    <div class="slot" data-id="4" style="top: 50%; left: 50%;"></div>
    </div>
  <div class="column1" style="top: 5%; left: 53%;">
    <div class="slot" data-id="5" style="top: 50%; left: 50%;"></div>
  </div>
  <div class="column1" style="top: 35%; left: 24%;">
    <div class="slot" data-id="6" style="top: 50%; left: 50%;"></div>
  </div>
  <div class="column1" style="top: 5%; left: 24%;">
    <div class="slot" data-id="7" style="top: 50%; left: 50%;"></div>
  </div>
  <div class="column1" style="top: 35%; left: 10%;">
    <div class="slot" data-id="8" style="top: 50%; left: 50%;"></div>
  </div>
  <div class="column1" style="top: 5%; left: 10%;">
    <div class="slot" data-id="9" style="top: 50%; left: 50%;"></div>
  </div>
  </div>

</div>
<div id="camera-floating" class="camera-floating"></div>

<script>
  const statusLabels = {
    '-1': 'ä¸æ˜ï¼ˆãƒ‡ãƒ¼ã‚¿ãªã—ï¼‰',
    '0': 'æº€è»Š',
    '1': 'æ®‹ã‚Šã‚ãšã‹',
    '2': 'ç©ºã',
    'default': 'ä¸æ˜ï¼ˆãƒ‡ãƒ¼ã‚¿ãªã—ï¼‰'
  };

  function updateSlotsFromData(data) {
    // ãƒ‡ãƒ¼ã‚¿ãŒé…åˆ—ã§ãªã„å ´åˆã‚„lengthãŒ9ã§ãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š
    if (!Array.isArray(data) || data.length !== 9) {
      console.warn('Invalid data format. Expected array of length 9.');
      data = new Array(9).fill(-1); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§å…¨ã¦-1ï¼ˆç°è‰²ï¼‰
    }

    document.querySelectorAll('.slot').forEach((slot) => {
      const id = parseInt(slot.dataset.id);       // 1-based
      const index = id - 1;                        // 0-based
      const status = data[index] ?? -1;            // é…åˆ—ã®å€¤ã‚’å–å¾—ã€ãªã‘ã‚Œã°-1

      // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«å¿œã˜ã¦ã‚¯ãƒ©ã‚¹ã‚’è¨­å®š
      const statusClass = 
        status === -1 ? 'error' :      // -1: ç°è‰²
        status === 0 ? 'occupied' :    // 0: èµ¤è‰²
        status === 1 ? 'few' :         // 1: é»„è‰²ï¼ˆã‚ªãƒ¬ãƒ³ã‚¸ï¼‰
        status === 2 ? 'vacant' :      // 2: ç·‘è‰²
        'error';                       // ãã®ä»–: ç°è‰²

      // ã‚¹ãƒ­ãƒƒãƒˆã®ã‚¯ãƒ©ã‚¹æ›´æ–°
      slot.classList.remove('vacant', 'few', 'occupied', 'error');
      slot.classList.add(statusClass);
      slot.textContent = status >= 0 ? id : '?';

      // è¦ªã® column1 ã«ã‚‚ã‚¯ãƒ©ã‚¹ã‚’åæ˜ 
      const column = slot.closest('.column1');
      if (column) {
        column.classList.remove('vacant', 'few', 'occupied', 'error');
        column.classList.add(statusClass);
      }
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    fetch('/api/parking_stats')
      .then(response => response.json())
      .then(data => {
        console.log('Received data:', data); // ãƒ‡ãƒãƒƒã‚°ç”¨
        updateSlotsFromData(data); // åˆæœŸè¡¨ç¤º
      })
      .catch(error => {
        console.error('ã‚¹ãƒ­ãƒƒãƒˆçŠ¶æ…‹ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', error);
        updateSlotsFromData(); // ã‚°ãƒ¬ãƒ¼è¡¨ç¤º
      });

    // æƒ…å ±è¡¨ç¤ºç”¨ã®å¹ãå‡ºã—
    const info = document.createElement('div');
    info.id = 'slot-info';
    info.className = 'slot-info';
    document.body.appendChild(info);

    const camFloat = document.getElementById('camera-floating');

    document.querySelectorAll('.slot').forEach(slot => {
      slot.addEventListener('click', e => {
        const id = slot.dataset.id;
        const label = slot.classList.contains('vacant') ? 'ç©ºã'
                    : slot.classList.contains('few')    ? 'æ®‹ã‚Šã‚ãšã‹'
                    : slot.classList.contains('occupied')? 'æº€è»Š'
                    : 'ä¸æ˜ï¼ˆãƒ‡ãƒ¼ã‚¿ãªã—ï¼‰';
        // å¹ãå‡ºã—è¡¨ç¤ºï¼ˆinfoã¯ä»»æ„ã§è¡¨ç¤ºå¯ï¼‰
        info.textContent = `ã‚¹ãƒ­ãƒƒãƒˆ ${id}ï¼š${label}`;
        info.style.display = 'block';

        // ãƒ‡ãƒ¼ã‚¿ãªã—ï¼ˆerrorï¼‰ã§ãªã‘ã‚Œã°ã‚«ãƒ¡ãƒ©ç”»åƒï¼ˆcamera1ã®ã¿ï¼‰ã‚’è¡¨ç¤º
        if (!slot.classList.contains('error')) {
          fetch('/api/camera1_image')
            .then(res => res.json())
            .then(data => {
              // camera1 ã®ç”»åƒã‚’ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã«æŒ¿å…¥
              camFloat.innerHTML = `<img src="data:image/jpeg;base64,${data.image}" alt="Cam1">`;
              // ãƒœã‚¿ãƒ³ï¼ˆslotï¼‰è¿‘ãã«é…ç½®
              const rect = e.target.getBoundingClientRect();
              camFloat.style.top  = (window.scrollY + rect.bottom + 5) + 'px';
              camFloat.style.left = (window.scrollX + rect.left)   + 'px';
              camFloat.style.display = 'block';

              const camRect = camFloat.getBoundingClientRect();
              if (camRect.right > window.innerWidth) {
                  const newLeft = window.innerWidth - camRect.width - 100;
                  camFloat.style.left = newLeft + 'px';
              }
              if (camRect.bottom > window.innerHeight) {
                  const newTop = window.innerHeight - camRect.height - 300;
                  camFloat.style.top = newTop + 'px';
              }
            })
            .catch(() => {
              camFloat.style.display = 'none';
            });
        } else {
          camFloat.style.display = 'none';
        }
      });
    });

    // ã‚¹ãƒ­ãƒƒãƒˆä»¥å¤–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰å¹ãå‡ºã—ãƒ»ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’éè¡¨ç¤º
    document.body.addEventListener('click', e => {
      if (!e.target.classList.contains('slot')) {
        info.style.display = 'none';
        camFloat.style.display = 'none';
      }
    });
  });
</script>

</body>
</html>